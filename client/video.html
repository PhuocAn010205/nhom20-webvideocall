<!-- client/video.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cu·ªôc G·ªçi H·ªôi Ngh·ªã</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { background-color: #f5f6fa; }
    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px; padding: 20px;
    }
    .video-card {
      background: #000; border-radius: 10px;
      position: relative; height: 200px; color: white;
      display: flex; justify-content: center; align-items: center;
    }
    .video-card video {
      width: 100%; height: 100%; border-radius: 10px; object-fit: cover;
    }
    .video-card .name {
      position: absolute; bottom: 5px; right: 10px;
      background: rgba(0,0,0,0.6);
      padding: 2px 8px; border-radius: 5px; font-size: 14px;
    }
    .controls { display: flex; justify-content: center; gap: 15px; margin: 15px 0; }
    .controls button { border-radius: 50%; width: 50px; height: 50px; font-size: 20px; }
    .chat-box { background: #fff; border-radius: 10px; height: 100%;
      display: flex; flex-direction: column; border: 1px solid #ddd; }
    .chat-messages { flex: 1; padding: 10px; overflow-y: auto; }
    .chat-messages p { margin: 0 0 5px; }
    .chat-input { display: flex; border-top: 1px solid #ddd; }
    .chat-input input { flex: 1; border: none; padding: 10px; outline: none; }
    .chat-input button { border: none; background: #4e73df; color: white; padding: 10px 15px; }
    #create-room-btn { margin: 10px 0; }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <!-- Video Grid -->
    <div class="col-md-8">
      <h3 class="text-center">Ph√≤ng: <span id="roomIdDisplay"></span></h3>
      <button id="create-room-btn" class="btn btn-success">T·∫°o Ph√≤ng M·ªõi</button>
      <div class="video-grid" id="video-grid"></div>
      <div class="controls">
        <button class="btn btn-light" id="btn-mic">üé§</button>
        <button class="btn btn-light" id="btn-camera">üì∑</button>
        <button class="btn btn-light" id="btn-screen">‚õ∂</button>
        <button class="btn btn-danger" id="btn-leave">‚èπ</button>
      </div>
    </div>

    <!-- Chat -->
    <div class="col-md-4">
      <div class="chat-box">
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input">
          <input type="text" id="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn...">
          <button id="send-btn">G·ª≠i</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Logic JS -->
<script>
  const socket = io('http://localhost:3000');
  const urlParams = new URLSearchParams(window.location.search);
  let roomId = urlParams.get("roomId");
  document.getElementById('roomIdDisplay').textContent = roomId || 'Ch∆∞a t·∫°o ph√≤ng';

  const userId = localStorage.getItem('user_id') || Math.floor(Math.random() * 10000);
  const username = localStorage.getItem('username') || `User${userId}`;
  const videoGrid = document.getElementById("video-grid");
  const chatMessages = document.getElementById("chat-messages");
  const chatInput = document.getElementById("chat-input");
  const sendBtn = document.getElementById("send-btn");
  const btnMic = document.getElementById("btn-mic");
  const btnCamera = document.getElementById("btn-camera");
  const btnScreen = document.getElementById("btn-screen");
  const btnLeave = document.getElementById("btn-leave");
  const createRoomBtn = document.getElementById("create-room-btn");

  let localStream;
  let peerConnections = {};

  // Get media
  navigator.mediaDevices.getUserMedia({ video: true, audio: true })
    .then(stream => {
      localStream = stream;
      addVideoStream(stream, username);

      if (roomId) {
        socket.emit("join-room", { roomId, userId, username });
      }
    })
    .catch(err => console.error('‚ùå L·ªói getUserMedia:', err));

  // Th√™m video
  function addVideoStream(stream, name) {
    const video = document.createElement("video");
    video.srcObject = stream;
    video.autoplay = true;
    video.playsInline = true;
    const wrapper = document.createElement("div");
    wrapper.classList.add("video-card");
    const nameTag = document.createElement("div");
    nameTag.classList.add("name");
    nameTag.innerText = name;
    wrapper.appendChild(video);
    wrapper.appendChild(nameTag);
    videoGrid.appendChild(wrapper);
  }

  // T·∫°o ph√≤ng m·ªõi
  createRoomBtn.addEventListener('click', () => {
    roomId = uuidv4();
    document.getElementById('roomIdDisplay').textContent = roomId;
    socket.emit("create-room", { creatorId: userId, username });
    socket.emit("join-room", { roomId, userId, username });
  });

  // Khi user m·ªõi join
  socket.on("user-joined", ({ userId: otherId, username: otherName }) => {
    console.log('üì° User joined:', otherName);
    createOffer(otherId, otherName);
    notify(`üîî ${otherName} ƒë√£ tham gia`);
  });

  // R·ªùi ph√≤ng
  socket.on("user-left", ({ username: leftName }) => {
    notify(`‚ùå ${leftName} ƒë√£ r·ªùi ph√≤ng`);
  });

  // Nh·∫≠n offer
  socket.on("offer", async ({ from, sdp }) => {
    console.log('üì° Nh·∫≠n offer t·ª´:', from);
    const pc = createPeerConnection(from);
    await pc.setRemoteDescription(new RTCSessionDescription(sdp));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit("answer", { roomId, to: from, sdp: answer });
  });

  // Nh·∫≠n answer
  socket.on("answer", async ({ from, sdp }) => {
    console.log('üì° Nh·∫≠n answer t·ª´:', from);
    const pc = peerConnections[from];
    if (pc) await pc.setRemoteDescription(new RTCSessionDescription(sdp));
  });

  // Nh·∫≠n ICE
  socket.on("ice-candidate", ({ from, candidate }) => {
    console.log('üì° Nh·∫≠n ICE t·ª´:', from);
    const pc = peerConnections[from];
    if (pc) pc.addIceCandidate(new RTCIceCandidate(candidate));
  });

  // ========== WebRTC functions ==========
  function createPeerConnection(otherId, otherName) {
    const pc = new RTCPeerConnection({
      iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    });
    peerConnections[otherId] = pc;

    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    pc.ontrack = (event) => {
      addVideoStream(event.streams[0], otherName || `Ng∆∞·ªùi d√πng ${otherId}`);
    };

    pc.onicecandidate = (event) => {
      if (event.candidate) {
        socket.emit("ice-candidate", { roomId, to: otherId, candidate: event.candidate });
      }
    };

    return pc;
  }

  async function createOffer(otherId, otherName) {
    const pc = createPeerConnection(otherId, otherName);
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit("offer", { roomId, to: otherId, sdp: offer });
  }

  // ========== Chat ==========
  sendBtn.addEventListener("click", () => {
    const msg = chatInput.value.trim();
    if (!msg) return;
    socket.emit("chat-message", {
      roomId,
      senderId: userId,
      senderName: username,
      receiverId: null,
      message: msg
    });
    chatInput.value = "";
  });

  socket.on("chat-message", (data) => {
    const p = document.createElement("p");
    p.innerHTML = `<b>${data.senderName}:</b> ${data.message}`;
    chatMessages.appendChild(p);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  });

  function notify(msg) {
    const p = document.createElement("p");
    p.innerHTML = `<i>${msg}</i>`;
    chatMessages.appendChild(p);
  }

  // ========== Controls ==========
  btnMic.addEventListener("click", () => {
    localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled;
    btnMic.classList.toggle("btn-success", localStream.getAudioTracks()[0].enabled);
    btnMic.classList.toggle("btn-danger", !localStream.getAudioTracks()[0].enabled);
  });

  btnCamera.addEventListener("click", () => {
    localStream.getVideoTracks()[0].enabled = !localStream.getVideoTracks()[0].enabled;
    btnCamera.classList.toggle("btn-success", localStream.getVideoTracks()[0].enabled);
    btnCamera.classList.toggle("btn-danger", !localStream.getVideoTracks()[0].enabled);
  });

  btnScreen.addEventListener("click", () => {
    navigator.mediaDevices.getDisplayMedia()
      .then(screenStream => {
        localStream.getVideoTracks()[0].enabled = false;
        screenStream.getVideoTracks()[0].onended = () => {
          localStream.getVideoTracks()[0].enabled = true;
        };
        localStream.addTrack(screenStream.getVideoTracks()[0]);
        addVideoStream(localStream, `${username} (Screen)`);
      })
      .catch(err => console.error('‚ùå L·ªói chia s·∫ª m√†n h√¨nh:', err));
  });

  btnLeave.addEventListener("click", () => {
    socket.emit("leave-room", { roomId, userId, username });
    window.location.href = "trangchu.html";
  });
</script>
</body>
</html>